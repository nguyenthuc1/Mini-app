<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - Fish Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-[#0f172a] text-white p-4">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-slate-800 p-4 rounded-xl shadow-lg">
            <h1 class="text-xl font-bold text-yellow-500">QU·∫¢N TR·ªä VI√äN üõ°Ô∏è</h1>
            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-xs font-bold transition">L√†m m·ªõi d·ªØ li·ªáu üîÑ</button>
        </header>

        <div id="section-withdraw" class="grid gap-4">
            <p class="text-center text-gray-500 py-20 italic">ƒêang t·∫£i l·ªánh r√∫t t·ª´ h·ªá th·ªëng...</p>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh Firebase c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // PH·∫¶N QUAN TR·ªåNG: L·∫Øng nghe d·ªØ li·ªáu t·ª´ Firebase
        db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val();
            const container = document.getElementById('section-withdraw');
            let html = '';
            let count = 0;

            if (!users) {
                container.innerHTML = '<p class="text-center py-10 text-gray-500">H·ªá th·ªëng ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o.</p>';
                return;
            }

            for (let uid in users) {
                const user = users[uid];
                // Ki·ªÉm tra l·ªãch s·ª≠ c·ªßa t·ª´ng user
                if (user.history && Array.isArray(user.history)) {
                    user.history.forEach((h, idx) => {
                        // Ch·ªâ hi·ªán l·ªánh r√∫t 'ƒêang x·ª≠ l√Ω'
                        if (h.status === 'üïê ƒêang x·ª≠ l√Ω') {
                            count++;
                            
                            // ƒê·ªëi so√°t th·ªùi gian ra kh∆°i ƒë·ªÉ ch·ªëng hack [cite: 2026-01-24]
                            let sailingTime = "Kh√¥ng r√µ";
                            let isCheat = false;
                            if (user.startTime) {
                                const mins = Math.floor((new Date() - new Date(user.startTime)) / 60000);
                                sailingTime = mins + " ph√∫t";
                                // Logic check hack: N·∫øu xu qu√° nhi·ªÅu m√† th·ªùi gian ch∆°i √≠t [cite: 2026-01-24]
                                if (user.coins > (mins * 2000) && mins > 0) isCheat = true;
                            }

                            html += `
                            <div class="bg-[#1e293b] border-2 ${isCheat ? 'border-red-500 bg-red-900/10' : 'border-slate-700'} p-5 rounded-2xl">
                                <div class="flex justify-between items-start mb-4">
                                    <span class="text-[10px] font-mono text-blue-400">ID: ${uid}</span>
                                    ${isCheat ? '<span class="bg-red-600 text-[8px] px-2 py-1 rounded animate-pulse">NGHI V·∫§N HACK</span>' : ''}
                                </div>
                                <h3 class="text-xl font-bold text-yellow-500 mb-3">${Number(h.amount).toLocaleString()} VNƒê</h3>
                                <div class="text-xs space-y-1 text-gray-300">
                                    <p>üè¶ Ng√¢n h√†ng: <b class="text-white">${h.bankName || 'N/A'}</b></p>
                                    <p>üí≥ STK: <b class="text-white">${h.bankAcc || 'N/A'}</b></p>
                                    <p>üë§ T√™n: <b class="text-white">${h.bankOwner || 'N/A'}</b></p>
                                    <p>‚è±Ô∏è ƒê√£ ra kh∆°i: <b class="${isCheat ? 'text-red-400' : 'text-green-400'}">${sailingTime}</b></p>
                                </div>
                                <div class="flex gap-2 mt-5">
                                    <button onclick="updateStatus('${uid}', ${idx}, '‚úÖ Th√†nh c√¥ng')" class="flex-1 bg-green-600 py-2 rounded-lg font-bold text-xs">DUY·ªÜT ‚úÖ</button>
                                    <button onclick="refund('${uid}', ${idx}, ${h.amount})" class="flex-1 bg-red-600 py-2 rounded-lg font-bold text-xs text-white">H·ª¶Y (HACK) ‚ùå</button>
                                </div>
                            </div>`;
                        }
                    });
                }
            }
            container.innerHTML = count > 0 ? html : '<p class="text-center py-10 text-gray-500">üéâ Kh√¥ng c√≥ l·ªánh r√∫t n√†o ch·ªù x·ª≠ l√Ω.</p>';
        });

        function updateStatus(uid, idx, status) {
            if (confirm('X√°c nh·∫≠n l·ªánh r√∫t n√†y h·ª£p l·ªá?')) {
                db.ref('users/' + uid + '/history/' + idx).update({ status: status });
            }
        }

        function refund(uid, idx, amount) {
            const reason = prompt("L√Ω do h·ªßy (S·ªë xu kh√¥ng kh·ªõp th·ªùi gian ch∆°i, gian l·∫≠n m·ªùi b·∫°n b√®...):", "Ph√°t hi·ªán gian l·∫≠n: Th·ªùi gian ra kh∆°i kh√¥ng kh·ªõp s·ªë xu.");
            if (!reason) return;

            db.ref('users/' + uid).once('value', (snap) => {
                const u = snap.val();
                const updates = {};
                updates['users/' + uid + '/coins'] = (Number(u.coins) || 0) + Number(amount);
                updates['users/' + uid + '/history/' + idx + '/status'] = '‚ùå B·ªã t·ª´ ch·ªëi: ' + reason;
                db.ref().update(updates).then(() => alert('ƒê√£ ho√†n ti·ªÅn v√† h·ªßy l·ªánh!'));
            });
        }
    </script>
</body>
</html>
