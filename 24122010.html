<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n Tr·ªã - Fish Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .tab-active { border-bottom: 2px solid #eab308; color: #eab308; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; }
        .bg-hack { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <header class="flex justify-between items-center mb-6 bg-slate-800 p-4 rounded-xl shadow-lg">
            <h1 class="text-xl font-bold text-yellow-500">ADMIN PANEL üõ°Ô∏è</h1>
            <button onclick="location.reload()" class="bg-blue-600 px-4 py-2 rounded-lg text-xs font-bold">L√†m m·ªõi üîÑ</button>
        </header>

        <div class="flex space-x-6 mb-6 border-b border-slate-700">
            <button id="tab-withdraw-btn" onclick="showTab('withdraw')" class="pb-2 text-sm font-bold tab-active">L·ªánh r√∫t ti·ªÅn</button>
            <button id="tab-user-btn" onclick="showTab('user')" class="pb-2 text-sm font-bold text-gray-400">Th·ªëng k√™ User</button>
        </div>

        <div id="tab-withdraw" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <p class="text-center text-gray-500 py-10 col-span-full">ƒêang qu√©t d·ªØ li·ªáu l·ªánh r√∫t...</p>
        </div>

        <div id="tab-user" class="hidden overflow-x-auto card p-4">
            <table class="w-full text-left text-xs">
                <thead class="text-gray-400 uppercase border-b border-slate-700">
                    <tr>
                        <th class="p-3">User ID</th>
                        <th class="p-3">Level</th>
                        <th class="p-3">S·ªë xu</th>
                        <th class="p-3">ƒê√£ m·ªùi</th>
                        <th class="p-3">Ra kh∆°i</th>
                        <th class="p-3">Tr·∫°ng th√°i</th>
                    </tr>
                </thead>
                <tbody id="user-table-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // 1. C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. H√ÄM KI·ªÇM TRA HACK (CHECK HACK STATUS)       
function checkHackStatus(user) {
    // 1. CHUY·ªÇN ƒê·ªîI TH·ªúI GIAN (X·ª≠ l√Ω c·∫£ d·∫°ng S·ªë v√† Ch·ªØ ƒë·ªÉ x√≥a l·ªói NaN)
    const rawStart = user.startTime;
    let startTimeMs = 0;
    if (rawStart) {
        startTimeMs = isNaN(rawStart) ? new Date(rawStart).getTime() : Number(rawStart);
    }

    // 2. T√çNH TH·ªúI GIAN RA KH∆†I TH·ª∞C T·∫æ
    const now = Date.now();
    const diffMs = startTimeMs > 0 ? (now - startTimeMs) : 0;
    const mins = Math.max(0, Math.floor(diffMs / 60000)); 

    // 3. T√çNH TO√ÅN THEO TH√îNG S·ªê GAME TH·∫¨T
    const speed = Number(user.speed || 1);
    const currentCoins = Number(user.coins || 0);
    
    // S·∫£n l∆∞·ª£ng: S·ªë ph√∫t * 60 gi√¢y * T·ªëc ƒë·ªô (c√°/s)
    const totalFishPotential = mins * (user.speed || 1) * 60;
const sailingCoins = totalFishPotential * 0.005;


    // Xu t·ª´ m·ªùi b·∫°n b√® (B·∫°n c√≥ th·ªÉ ƒëi·ªÅu ch·ªânh 2000 th√†nh s·ªë xu th·ª±c t·∫ø t·∫∑ng m·ªói l∆∞·ª£t)
    const invited = user.referrals ? Object.keys(user.referrals).length : 0;
    const inviteCoins = invited * 2000;

    // T·ªîNG XU T·ªêI ƒêA (C·ªông 100 xu ƒë·ªám ƒë·ªÉ tr√°nh b√°o sai cho User m·ªõi)
    const totalMaxAllowed = sailingCoins + inviteCoins + 100;

    // 4. TR·∫¢ V·ªÄ K·∫æT QU·∫¢
    if (currentCoins > totalMaxAllowed && mins > 0) {
        return { 
            isSus: true, 
            reason: `Nghi v·∫•n (Max: ${Math.floor(totalMaxAllowed)} xu | ƒêang c√≥: ${currentCoins} xu)` 
        };
    }

    return { isSus: false, reason: "H·ª£p l·ªá" };
}

        // 3. HI·ªÇN TH·ªä D·ªÆ LI·ªÜU
        db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val();
            renderWithdrawals(users);
            renderUsers(users);
        });

        function renderWithdrawals(users) {
            const container = document.getElementById('tab-withdraw');
            let html = '';
            for (let uid in users) {
                const u = users[uid];
                if (u.history) {
                    u.history.forEach((h, idx) => {
                        if (h.status === 'üïê ƒêang x·ª≠ l√Ω') {
                            const status = checkHackStatus(u); // Ki·ªÉm tra hack t·∫°i ƒë√¢y [cite: 2026-01-24]
                            html += `
                            <div class="card p-4 ${status.isSus ? 'bg-hack' : ''}">
                                <div class="flex justify-between mb-2">
                                    <span class="text-[10px] text-blue-400">ID: ${uid}</span>
                                    ${status.isSus ? '<span class="text-red-500 text-[10px] font-bold animate-pulse">‚ö†Ô∏è NGHI V·∫§N</span>' : ''}
                                </div>
                                <h3 class="text-xl font-bold text-yellow-500">${Number(h.amount).toLocaleString()} VNƒê</h3>
                                <div class="text-[11px] text-gray-400 mt-2">
                                    <p>üè¶ ${h.bankName} | üë§ ${h.bankOwner}</p>
                                    <p>üí≥ STK: ${h.bankAcc}</p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button onclick="approve('${uid}', ${idx})" class="flex-1 bg-green-600 py-1 rounded font-bold text-xs">DUY·ªÜT</button>
                                    <button onclick="refund('${uid}', ${idx}, ${h.amount})" class="flex-1 bg-red-600 py-1 rounded font-bold text-xs">H·ª¶Y/HO√ÄN TI·ªÄN</button>
                                </div>
                            </div>`;
                        }
                    });
                }
            }
            container.innerHTML = html || '<p class="text-center py-10 text-gray-500 col-span-full">üéâ Kh√¥ng c√≥ l·ªánh ch·ªù.</p>';
        }

        function renderUsers(users) {
            const body = document.getElementById('user-table-body');
            let html = '';
            for (let uid in users) {
                const u = users[uid];
                const status = checkHackStatus(u); // Ki·ªÉm tra hack t·∫°i ƒë√¢y [cite: 2026-01-24]
                const mins = u.startTime ? Math.floor((new Date() - new Date(u.startTime)) / 60000) : 0;
                const invited = u.referrals ? Object.keys(u.referrals).length : 0;

                html += `
                <tr class="border-b border-slate-800 ${status.isSus ? 'bg-red-900/10' : ''}">
                    <td class="p-3 font-mono text-blue-400">${uid}</td>
                    <td class="p-3 text-yellow-500">Lv.${u.shipLevel || 1}</td>
                    <td class="p-3 font-bold">${Number(u.coins || 0).toLocaleString()}</td>
                    <td class="p-3">${invited} ng∆∞·ªùi</td>
                    <td class="p-3 text-gray-400">${mins} ph√∫t</td>
                    <td class="p-3 font-bold ${status.isSus ? 'text-red-500' : 'text-green-500'}">${status.isSus ? '‚ö†Ô∏è ' + status.reason : '‚úÖ OK'}</td>
                </tr>`;
            }
            body.innerHTML = html;
        }

        function showTab(tab) {
            document.getElementById('tab-withdraw').classList.toggle('hidden', tab !== 'withdraw');
            document.getElementById('tab-user').classList.toggle('hidden', tab !== 'user');
            document.getElementById('tab-withdraw-btn').classList.toggle('tab-active', tab === 'withdraw');
            document.getElementById('tab-user-btn').classList.toggle('tab-active', tab === 'user');
        }

        function approve(uid, idx) {
            if(confirm('Duy·ªát l·ªánh r√∫t n√†y?')) db.ref(`users/${uid}/history/${idx}`).update({ status: '‚úÖ Th√†nh c√¥ng' });
        }

        function refund(uid, idx, amount) {
            const reason = prompt("L√Ω do h·ªßy:", "Ph√°t hi·ªán gian l·∫≠n: Th√¥ng s·ªë xu kh√¥ng h·ª£p l·ªá.");
            if (!reason) return;
            db.ref(`users/${uid}`).once('value', (snap) => {
                const u = snap.val();
                const updates = {};
                updates[`users/${uid}/coins`] = (Number(u.coins) || 0) + Number(amount);
                updates[`users/${uid}/history/${idx}/status`] = '‚ùå B·ªã t·ª´ ch·ªëi: ' + reason;
                db.ref().update(updates).then(() => alert('ƒê√£ h·ªßy v√† ho√†n ti·ªÅn!'));
            });
        }
    </script>
</body>
</html>
