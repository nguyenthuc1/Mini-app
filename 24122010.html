<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Fish Mining Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-[#0b0f1a] text-white p-4 font-sans">
    <div class="max-w-6xl mx-auto">
        <header class="flex flex-wrap justify-between items-center mb-6 bg-[#161b2c] p-6 rounded-2xl border border-slate-700 gap-4">
            <div>
                <h1 class="text-xl font-bold text-yellow-500 uppercase">H·ªá Th·ªëng Qu·∫£n Tr·ªã</h1>
                <p class="text-xs text-gray-400 mt-1">Duy·ªát l·ªánh r√∫t & Ki·ªÉm tra th·ªùi gian ra kh∆°i [cite: 2026-01-24]</p>
            </div>
            <div class="flex gap-2">
                <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-bold text-sm transition-all">L√†m m·ªõi üîÑ</button>
            </div>
        </header>

        <div class="flex gap-4 mb-6">
            <button onclick="switchTab('withdraw')" id="tab-withdraw" class="px-6 py-2 rounded-full bg-yellow-600 font-bold text-sm">L·ªánh r√∫t ti·ªÅn</button>
            <button onclick="switchTab('users')" id="tab-users" class="px-6 py-2 rounded-full bg-[#161b2c] font-bold text-sm border border-slate-700">Th·ªëng k√™ User</button>
        </div>

        <div id="section-withdraw" class="grid grid-cols-1 gap-4">
            <div class="text-center py-20 text-gray-500 italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>
        </div>

        <div id="section-users" class="hidden overflow-x-auto bg-[#161b2c] rounded-2xl border border-slate-700">
            <table class="w-full text-left text-sm">
                <thead class="bg-[#1e253a] text-gray-400 uppercase text-[10px] tracking-wider">
    <tr>
        <th class="p-4">User ID</th>
        <th class="p-4">S·ªë d∆∞ Xu</th>
        <th class="p-4">Th·ªùi gian (Lv)</th>
        <th class="p-4">ƒê√°nh gi√° & Refs</th>
    </tr>
</thead>
                <tbody id="user-stats-body"></tbody>
            </table>
        </div>
    </div>

    <script>
        // C·∫•u h√¨nh Firebase [cite: 2026-01-24]
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // ƒêƒÉng nh·∫≠p Admin [cite: 2026-01-24]
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) await firebase.auth().signInAnonymously();
            else loadData();
        });

        function switchTab(tab) {
            document.getElementById('section-withdraw').classList.toggle('hidden', tab !== 'withdraw');
            document.getElementById('section-users').classList.toggle('hidden', tab !== 'users');
            document.getElementById('tab-withdraw').className = tab === 'withdraw' ? "px-6 py-2 rounded-full bg-yellow-600 font-bold text-sm" : "px-6 py-2 rounded-full bg-[#161b2c] border border-slate-700 font-bold text-sm";
            document.getElementById('tab-users').className = tab === 'users' ? "px-6 py-2 rounded-full bg-yellow-600 font-bold text-sm" : "px-6 py-2 rounded-full bg-[#161b2c] border border-slate-700 font-bold text-sm";
        }

        async function loadData() {
            try {
                const snap = await db.ref('users').once('value');
                const allUsers = snap.val() || {};
                renderWithdrawals(allUsers);
                renderUserStats(allUsers);
            } catch (e) { alert("L·ªói t·∫£i data: " + e.message); }
        }

        // 1. Hi·ªÉn th·ªã l·ªánh r√∫t ti·ªÅn [cite: 2026-01-24]
        function renderWithdrawals(users) {
            const container = document.getElementById('section-withdraw');
            let html = '';
            let count = 0;
            for (let uid in users) {
                (users[uid].history || []).forEach((item, idx) => {
                    if (item.status === 'ƒêang x·ª≠ l√Ω') {
                        count++;
                        html += `
                        <div class="bg-[#161b2c] border border-slate-700 p-5 rounded-2xl flex flex-wrap justify-between items-center gap-4">
                            <div class="flex-1 min-w-[200px]">
                                <p class="text-[10px] text-blue-400 font-mono italic">ID: ${uid}</p>
                                <h3 class="font-bold text-lg text-white">${item.amount.toLocaleString()} VNƒê</h3>
                                <div class="text-xs text-gray-400 mt-2 space-y-1">
                                    <p>üè¶ Ng√¢n h√†ng: ${item.bank}</p>
                                    <p>üí≥ STK: ${item.account}</p>
                                    <p>üë§ T√™n: <span class="text-yellow-500 font-bold">${item.name || 'N/A'}</span></p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="updateStatus('${uid}', ${idx}, 'Th√†nh c√¥ng')" class="bg-green-600 px-4 py-2 rounded-lg text-xs font-bold">DUY·ªÜT ‚úÖ</button>
                                <button onclick="refundPrompt('${uid}', ${idx}, ${item.amount})" class="bg-red-600 px-4 py-2 rounded-lg text-xs font-bold">H·ª¶Y ‚ùå</button>
                            </div>
                        </div>`;
                    }
                });
            }
            container.innerHTML = count > 0 ? html : '<div class="text-center py-10 text-gray-500">Kh√¥ng c√≥ l·ªánh ch·ªù!</div>';
        }

        // 2. Th·ªëng k√™ th·ªùi gian ra kh∆°i ƒë·ªÉ t√≠nh xu [cite: 2026-01-24]
      function renderUserStats(users) {
    const body = document.getElementById('user-stats-body');
    let html = '';

    for (let uid in users) {
        const u = users[uid];
        const totalSeconds = u.total_time || 0;
        const hours = (totalSeconds / 3600).toFixed(2);
        const currentSpeed = u.speed || 1;

        // T√çNH TO√ÅN T·ª∞ ƒê·ªòNG [cite: 2026-01-24]
        const maxPossibleFish = totalSeconds * currentSpeed;
        const currentFishAndCoinsInC√° = (u.coins / 0.005) + (u.fish || 0); 

        let statusTag = '<span class="text-green-400">H·ª£p l·ªá ‚úÖ</span>';

        if (currentFishAndCoinsInC√° > maxPossibleFish + 1000) { 
            statusTag = '<span class="text-red-500 font-bold underline">C·∫¢NH B√ÅO REG/HACK ‚ö†Ô∏è</span>';
        } else if (totalSeconds < 3600 && u.coins >= 20000) {
            statusTag = '<span class="text-yellow-500">NICK M·ªöI (REG) üë§</span>';
        }

        // CH·ªà D√ôNG 1 L·∫¶N html += v√† ƒë√≥ng ƒë√∫ng d·∫•u ngo·∫∑c backtick (`)
        html += `
        <tr class="border-t border-slate-800 hover:bg-white/5">
            <td class="p-4 font-mono text-xs text-blue-400">${uid}</td>
            <td class="p-4 text-yellow-500 font-bold">${(u.coins || 0).toLocaleString()}</td>
            <td class="p-4">${hours}h <span class="text-[10px] text-gray-500">(Lv: ${currentSpeed})</span></td>
            <td class="p-4 text-xs">
                ${statusTag} <br> 
                <span class="text-blue-400 font-bold">M·ªùi: ${u.total_refs || 0} ng∆∞·ªùi</span>
            </td>
        </tr>`;
    }
    body.innerHTML = html;
}

        async function updateStatus(uid, idx, status) {
            if (confirm("X√°c nh·∫≠n l·ªánh n√†y?")) {
                await db.ref(`users/${uid}/history/${idx}`).update({ status: status });
                loadData();
            }
        }

        // 3. Ho√†n ti·ªÅn k√®m l√Ω do [cite: 2026-01-24]
        async function refundPrompt(uid, idx, amount) {
            const reason = prompt("Nh·∫≠p l√Ω do h·ªßy l·ªánh (v√≠ d·ª•: Sai s·ªë t√†i kho·∫£n):", "Th√¥ng tin ng√¢n h√†ng kh√¥ng ch√≠nh x√°c");
            if (reason === null) return;

            try {
                const userRef = db.ref(`users/${uid}`);
                const snap = await userRef.once('value');
                const currentCoins = snap.val().coins || 0;

                await userRef.update({ coins: currentCoins + amount }); // Ho√†n l·∫°i xu [cite: 2026-01-23, 2026-01-24]
                await userRef.child(`history/${idx}`).update({ 
                    status: 'B·ªã t·ª´ ch·ªëi',
                    admin_note: reason,
                    time_refund: new Date().toLocaleString('vi-VN')
                });

                alert("ƒê√£ ho√†n ti·ªÅn v√† g·ª≠i th√¥ng b√°o l√Ω do!");
                loadData();
            } catch (e) { alert(e.message); }
        }
    </script>
</body>
</html>
