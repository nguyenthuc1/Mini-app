<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω R√∫t Ti·ªÅn - Fish Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-[#0b0f1a] text-white p-4 font-sans">
    <div class="max-w-5xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-[#161b2c] p-6 rounded-2xl border border-slate-700">
            <div>
                <h1 class="text-xl font-bold text-yellow-500 uppercase tracking-wider">H·ªá Th·ªëng Duy·ªát L·ªánh</h1>
                <p class="text-xs text-gray-400 mt-1">D·ªØ li·ªáu th·ªùi gian th·ª±c t·ª´ Firebase</p>
            </div>
            <button onclick="loadRequests()" class="bg-blue-600 hover:bg-blue-500 px-6 py-2 rounded-xl font-bold text-sm transition-all active:scale-95">
                L√†m m·ªõi üîÑ
            </button>
        </header>

        <div class="grid grid-cols-1 gap-4" id="admin-list">
            <div class="text-center py-20 text-gray-500 italic">ƒêang t·∫£i l·ªánh r√∫t...</div>
        </div>
    </div>

    <script>
        // C·∫§U H√åNH FIREBASE (Gi·ªØ nguy√™n config c·ªßa b·∫°n) [cite: 2026-01-24]
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. T·ª∞ ƒê·ªòNG ƒêƒÇNG NH·∫¨P ƒê·ªÇ TR√ÅNH L·ªñI RULES [cite: 2026-01-24]
        firebase.auth().onAuthStateChanged(async (user) => {
            if (!user) {
                await firebase.auth().signInAnonymously();
            } else {
                console.log("Admin ƒë√£ ƒëƒÉng nh·∫≠p:", user.uid);
                loadRequests();
            }
        });

        // 2. T·∫¢I DANH S√ÅCH L·ªÜNH R√öT [cite: 2026-01-24]
        async function loadRequests() {
            const container = document.getElementById('admin-list');
            try {
                const snap = await db.ref('users').once('value');
                const allUsers = snap.val();
                let html = '';
                let hasRequest = false;

                for (let uid in allUsers) {
                    const userData = allUsers[uid];
                    if (userData.history) {
                        userData.history.forEach((item, index) => {
                            // Ch·ªâ hi·ªÉn th·ªã c√°c l·ªánh c√≥ tr·∫°ng th√°i "ƒêang x·ª≠ l√Ω" [cite: 2026-01-24]
                            if (item.status === 'ƒêang x·ª≠ l√Ω') {
                                hasRequest = true;
                                html += createRequestCard(uid, item, index);
                            }
                        });
                    }
                }
                container.innerHTML = hasRequest ? html : '<div class="text-center py-20 bg-[#161b2c] rounded-2xl text-gray-500">üéâ Hi·ªán t·∫°i kh√¥ng c√≥ l·ªánh n√†o c·∫ßn duy·ªát!</div>';
            } catch (error) {
                container.innerHTML = `<div class="bg-red-900/20 border border-red-500 p-6 rounded-2xl text-red-500 text-center">L·ªói: ${error.message}<br>Th·ª©c h√£y ki·ªÉm tra l·∫°i Rules tr√™n Firebase!</div>`;
            }
        }

        function createRequestCard(uid, item, index) {
            return `
            <div class="bg-[#161b2c] border border-slate-700 p-5 rounded-2xl flex flex-wrap justify-between items-center gap-4 hover:border-blue-500/50 transition-all">
                <div class="flex-1 min-w-[250px]">
                    <p class="text-[10px] text-blue-400 font-mono mb-1">USER ID: ${uid}</p>
                    <h3 class="font-bold text-lg text-white mb-2">${item.amount.toLocaleString()} VNƒê</h3>
                    <div class="text-xs space-y-1 text-gray-400">
                        <p>üè¶ <b>Ng√¢n h√†ng:</b> ${item.bank}</p>
                        <p>üí≥ <b>S·ªë t√†i kho·∫£n:</b> ${item.account}</p>
                        <p>üë§ <b>Ch·ªß t√†i kho·∫£n:</b> ${item.name || 'N/A'}</p>
                        <p class="text-[10px] text-gray-500 mt-2 italic">üïí G·ª≠i l√∫c: ${item.time}</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="updateStatus('${uid}', ${index}, 'Th√†nh c√¥ng')" class="bg-green-600 hover:bg-green-500 px-5 py-3 rounded-xl text-xs font-bold transition-all shadow-lg shadow-green-900/20">
                        DUY·ªÜT CHI ‚úÖ
                    </button>
                    <button onclick="refund('${uid}', ${index}, ${item.amount})" class="bg-red-600/20 hover:bg-red-600 border border-red-600 text-red-500 hover:text-white px-5 py-3 rounded-xl text-xs font-bold transition-all">
                        H·ª¶Y & HO√ÄN TI·ªÄN ‚ùå
                    </button>
                </div>
            </div>`;
        }

        // 3. DUY·ªÜT L·ªÜNH [cite: 2026-01-24]
        async function updateStatus(uid, index, status) {
            if (!confirm(`X√°c nh·∫≠n ƒë√£ chuy·ªÉn ti·ªÅn cho user ${uid}?`)) return;
            try {
                await db.ref(`users/${uid}/history/${index}`).update({ status: status });
                alert("ƒê√£ duy·ªát th√†nh c√¥ng!");
                loadRequests();
            } catch (e) { alert("L·ªói: " + e.message); }
        }

        // 4. H·ª¶Y L·ªÜNH V√Ä HO√ÄN TI·ªÄN (CH·ªêNG M·∫§T TI·ªÄN USER) [cite: 2026-01-24]
        async function refund(uid, index, amount) {
            if (!confirm("H·ªßy l·ªánh r√∫t n√†y v√† c·ªông l·∫°i ti·ªÅn cho ng∆∞·ªùi ch∆°i?")) return;
            try {
                const userRef = db.ref(`users/${uid}`);
                const snap = await userRef.once('value');
                const userData = snap.val();
                
                // C·ªông l·∫°i ti·ªÅn v√†o s·ªë d∆∞ hi·ªán t·∫°i c·ªßa user [cite: 2026-01-23, 2026-01-24]
                const newCoins = (userData.coins || 0) + amount;
                
                await userRef.update({ coins: newCoins });
                await userRef.child(`history/${index}`).update({ status: 'B·ªã t·ª´ ch·ªëi (ƒê√£ ho√†n ti·ªÅn)' });
                
                alert("ƒê√£ h·ªßy l·ªánh v√† ho√†n l·∫°i " + amount.toLocaleString() + " xu cho user!");
                loadRequests();
            } catch (e) { alert("L·ªói khi ho√†n ti·ªÅn: " + e.message); }
        }
    </script>
</body>
</html>
