<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n Tr·ªã Vi√™n - Fish Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 1rem; }
        .warning { border-color: #ef4444; background: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body class="p-4">
    <div class="max-w-4xl mx-auto">
        <header class="flex justify-between items-center mb-8 bg-slate-800 p-4 rounded-xl">
            <h1 class="text-xl font-bold text-yellow-500">QU·∫¢N TR·ªä VI√äN üõ°Ô∏è</h1>
            <button onclick="location.reload()" class="bg-blue-600 px-4 py-2 rounded-lg text-xs">L√†m m·ªõi d·ªØ li·ªáu</button>
        </header>

        <div id="withdraw-list" class="grid gap-4">
            <p class="text-center text-gray-500 py-10">ƒêang qu√©t l·ªánh r√∫t t·ª´ Firebase...</p>
        </div>
    </div>

    <script>
        // S·ª≠ d·ª•ng ƒë√∫ng Config c·ªßa b·∫°n
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('users').on('value', (snapshot) => {
            const users = snapshot.val();
            const container = document.getElementById('withdraw-list');
            let html = '';

            for (let uid in users) {
                const user = users[uid];
                if (user.history && Array.isArray(user.history)) {
                    user.history.forEach((h, idx) => {
                        // Kh·ªõp ch√≠nh x√°c Status t·ª´ app.js
                        if (h.status === 'üïê ƒêang x·ª≠ l√Ω') {
                            
                            // T√çNH TO√ÅN CH·ªêNG HACK
                            let sailingInfo = "Ch∆∞a c√≥ d·ªØ li·ªáu";
                            let isCheat = false;
                            if (user.startTime) {
                                const mins = Math.floor((new Date() - new Date(user.startTime)) / 60000);
                                sailingInfo = mins + " ph√∫t";
                                // N·∫øu s·ªë xu l·ªõn b·∫•t th∆∞·ªùng so v·ªõi th·ªùi gian (V√≠ d·ª• 1 ph√∫t > 2000 xu)
                                if (user.coins > (mins * 2000) && mins > 0) isCheat = true;
                            }

                            html += `
                            <div class="card p-5 ${isCheat ? 'warning' : ''}">
                                <div class="flex justify-between text-[10px] text-gray-500 mb-2">
                                    <span>ID: ${uid}</span>
                                    <span>${h.time}</span>
                                </div>
                                <div class="text-xl font-bold text-yellow-400 mb-4">${Number(h.amount).toLocaleString()} VNƒê</div>
                                <div class="grid grid-cols-1 gap-1 text-sm text-gray-300">
                                    <p>üè¶ Ng√¢n h√†ng: <b class="text-white">${h.bankName || 'N/A'}</b></p>
                                    <p>üí≥ STK: <b class="text-white">${h.bankAcc || 'N/A'}</b></p>
                                    <p>üë§ T√™n: <b class="text-white">${h.bankOwner || 'N/A'}</b></p>
                                    <p>‚è±Ô∏è Th·ªùi gian ra kh∆°i: <b class="${isCheat ? 'text-red-500' : 'text-green-400'}">${sailingInfo}</b></p>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button onclick="updateStatus('${uid}', ${idx}, '‚úÖ Th√†nh c√¥ng')" class="flex-1 bg-green-600 py-2 rounded-lg font-bold text-xs">DUY·ªÜT</button>
                                    <button onclick="refund('${uid}', ${idx}, ${h.amount})" class="flex-1 bg-red-600 py-2 rounded-lg font-bold text-xs">H·ª¶Y (HACK)</button>
                                </div>
                            </div>`;
                        }
                    });
                }
            }
            container.innerHTML = html || '<p class="text-center text-gray-500 py-10">Kh√¥ng c√≥ l·ªánh ch·ªù x·ª≠ l√Ω n√†o.</p>';
        });

        function updateStatus(uid, idx, status) {
            if (confirm('X√°c nh·∫≠n l·ªánh n√†y h·ª£p l·ªá?')) {
                db.ref(\`users/\${uid}/history/\${idx}\`).update({ status: status });
            }
        }

        function refund(uid, idx, amount) {
            const reason = prompt("L√Ω do h·ªßy:", "Ph√°t hi·ªán gian l·∫≠n: Th·ªùi gian ra kh∆°i kh√¥ng kh·ªõp s·ªë xu.");
            if (!reason) return;

            db.ref(\`users/\${uid}\`).once('value', (snap) => {
                const u = snap.val();
                db.ref(\`users/\${uid}\`).update({
                    coins: (Number(u.coins) || 0) + Number(amount)
                });
                db.ref(\`users/\${uid}/history/\${idx}\`).update({
                    status: '‚ùå B·ªã t·ª´ ch·ªëi: ' + reason
                });
                alert('ƒê√£ ho√†n ti·ªÅn v√† h·ªßy l·ªánh!');
            });
        }
    </script>
</body>
</html>
