<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin System - Fish Mining</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); }
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans min-h-screen">

    <nav class="bg-gray-800 border-b border-gray-700 p-4 sticky top-0 z-30">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-shield-halved text-yellow-500 text-2xl"></i>
                <h1 class="text-xl font-bold bg-gradient-to-r from-yellow-400 to-orange-500 bg-clip-text text-transparent">ADMIN CONTROL</h1>
            </div>
            <div id="admin-status" class="text-xs font-mono text-gray-400">Checking auth...</div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-4 md:p-6 space-y-6">

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                <p class="text-gray-400 text-xs uppercase">ƒê∆°n ch·ªù duy·ªát</p>
                <h2 id="pending-count" class="text-3xl font-bold text-blue-400">0</h2>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg">
                <p class="text-gray-400 text-xs uppercase">T·ªïng ti·ªÅn ch·ªù r√∫t</p>
                <h2 id="total-pending-amount" class="text-3xl font-bold text-yellow-400">0</h2>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl border border-gray-700 shadow-lg flex items-center justify-between">
                <div>
                    <p class="text-gray-400 text-xs uppercase">Tr·∫°ng th√°i</p>
                    <h2 class="text-xl font-bold text-green-400">H·ªá th·ªëng Online</h2>
                </div>
                <button onclick="loadWithdrawals()" class="bg-blue-600 hover:bg-blue-500 p-3 rounded-full shadow-lg transition transform active:scale-95">
                    <i class="fa-solid fa-rotate"></i>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 rounded-xl shadow-xl border border-gray-700 overflow-hidden">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-800/50">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-list mr-2 text-blue-400"></i>Danh s√°ch y√™u c·∫ßu r√∫t ti·ªÅn</h3>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-700/50 text-gray-400 text-xs uppercase">
                            <th class="p-4">Th·ªùi gian</th>
                            <th class="p-4">User Info</th>
                            <th class="p-4">Ng√¢n h√†ng</th>
                            <th class="p-4 text-right">S·ªë ti·ªÅn</th>
                            <th class="p-4 text-center">Soi User</th>
                            <th class="p-4 text-center">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawal-list" class="divide-y divide-gray-700 text-sm">
                        <tr><td colspan="6" class="p-8 text-center text-gray-500">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-check-user" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-50"></div>
        <div class="modal-container bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto border border-gray-600">
            <div class="p-4 border-b border-gray-700 flex justify-between items-center">
                <h3 class="font-bold text-lg">üïµÔ∏è Soi th√¥ng tin User</h3>
                <button onclick="toggleModal('modal-check-user')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-4" id="user-details-content">
                <div class="text-center"><i class="fa-solid fa-circle-notch fa-spin text-blue-500 text-2xl"></i></div>
            </div>
            <div class="p-4 bg-gray-900/50 text-right">
                <button onclick="toggleModal('modal-check-user')" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="modal-reject" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-50"></div>
        <div class="modal-container bg-gray-800 w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto border border-red-500/50">
            <div class="p-4 border-b border-gray-700 bg-red-900/20">
                <h3 class="font-bold text-lg text-red-400">‚õî T·ª´ ch·ªëi ƒë∆°n r√∫t</h3>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-sm text-gray-300">B·∫°n ƒëang t·ª´ ch·ªëi ƒë∆°n r√∫t <b class="text-white" id="reject-amount">0</b> xu c·ªßa <b class="text-white" id="reject-user">...</b></p>
                
                <div>
                    <label class="block text-xs text-gray-400 mb-1">L√Ω do t·ª´ ch·ªëi (User s·∫Ω th·∫•y):</label>
                    <select id="reject-reason" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-sm focus:border-red-500 outline-none">
                        <option value="Sai th√¥ng tin ng√¢n h√†ng">üè¶ Sai th√¥ng tin ng√¢n h√†ng</option>
                        <option value="Nghi v·∫•n gian l·∫≠n (Hack)">‚ö†Ô∏è Nghi v·∫•n gian l·∫≠n (Hack)</option>
                        <option value="H·ªá th·ªëng b·∫£o tr√¨">üõ† H·ªá th·ªëng b·∫£o tr√¨</option>
                        <option value="Kh√°c">üìù L√Ω do kh√°c</option>
                    </select>
                </div>

                <div class="flex items-center p-3 bg-gray-900 rounded border border-gray-700">
                    <input type="checkbox" id="refund-checkbox" class="w-5 h-5 text-green-600 rounded focus:ring-green-500" checked>
                    <label for="refund-checkbox" class="ml-3 text-sm font-medium text-gray-200">
                        Ho√†n l·∫°i ti·ªÅn cho kh√°ch? <br>
                        <span class="text-xs text-gray-500">(Tick ch·ªçn ƒë·ªÉ tr·∫£ l·∫°i xu v√†o v√≠ User)</span>
                    </label>
                </div>
                
                <input type="hidden" id="reject-id">
                <input type="hidden" id="reject-uid">
                <input type="hidden" id="reject-val">
            </div>
            <div class="p-4 bg-gray-900/50 flex justify-end gap-3">
                <button onclick="toggleModal('modal-reject')" class="px-4 py-2 text-gray-400 hover:text-white text-sm">H·ªßy</button>
                <button onclick="confirmReject()" class="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg text-sm font-bold shadow-lg shadow-red-900/50">X√°c nh·∫≠n H·ªßy ƒê∆°n</button>
            </div>
        </div>
    </div>

    <script>
        // 1. C·∫§U H√åNH FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        // 2. CHECK LOGIN
        auth.onAuthStateChanged((user) => {
            if (user) {
                document.getElementById('admin-status').innerHTML = `<span class="text-green-400">‚óè Online: ${user.uid.substring(0,5)}...</span>`;
                loadWithdrawals();
            } else {
                document.getElementById('admin-status').innerText = "Logging in...";
                auth.signInAnonymously().catch(e => alert("L·ªói ƒëƒÉng nh·∫≠p: " + e.message));
            }
        });

        // 3. LOAD WITHDRAWALS
        function loadWithdrawals() {
            const list = document.getElementById('withdrawal-list');
            list.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500"><i class="fa-solid fa-spinner fa-spin mr-2"></i>ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>';

            db.ref('withdrawals').orderByChild('timestamp').limitToLast(100).once('value', snapshot => {
                const data = snapshot.val();
                if (!data) {
                    list.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-gray-500">üì≠ Hi·ªán kh√¥ng c√≥ ƒë∆°n n√†o</td></tr>';
                    document.getElementById('pending-count').innerText = 0;
                    document.getElementById('total-pending-amount').innerText = 0;
                    return;
                }

                const orders = Object.entries(data).map(([key, val]) => ({ id: key, ...val })).reverse();
                
                // C·∫≠p nh·∫≠t th·ªëng k√™
                document.getElementById('pending-count').innerText = orders.length;
                const total = orders.reduce((sum, order) => sum + (parseInt(order.amount) || 0), 0);
                document.getElementById('total-pending-amount').innerText = total.toLocaleString();

                let html = '';
                orders.forEach(order => {
                    html += `
                        <tr class="border-b border-gray-700 hover:bg-gray-800/50 transition group" id="row-${order.id}">
                            <td class="p-4">
                                <div class="font-bold text-white">${order.time.split(' ')[1]}</div>
                                <div class="text-xs text-gray-500">${order.time.split(' ')[0]}</div>
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-blue-400">${order.username || 'Kh√¥ng t√™n'}</div>
                                <div class="text-xs text-gray-500 font-mono bg-gray-900 px-1 rounded inline-block cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText('${order.userId}')" title="B·∫•m ƒë·ªÉ copy ID">${order.userId.substring(0, 8)}...</div>
                            </td>
                            <td class="p-4">
                                <div class="font-bold text-yellow-400">${order.bankName}</div>
                                <div class="font-mono text-gray-300">${order.bankAcc}</div>
                                <div class="text-[10px] uppercase text-gray-500 font-bold tracking-wider">${order.bankOwner}</div>
                            </td>
                            <td class="p-4 text-right">
                                <div class="font-bold text-green-400 text-lg">${parseInt(order.amount).toLocaleString()}</div>
                                <div class="text-xs text-gray-500">xu</div>
                            </td>
                            <td class="p-4 text-center">
                                <button onclick="checkUser('${order.userId}')" class="text-gray-400 hover:text-purple-400 transition" title="Soi th√¥ng tin User">
                                    <i class="fa-solid fa-eye fa-lg"></i>
                                </button>
                            </td>
                            <td class="p-4 text-center flex justify-center gap-2">
                                <button onclick="deleteOrder('${order.id}')" class="bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg shadow transition active:scale-95" title="ƒê√£ chuy·ªÉn ti·ªÅn xong">
                                    <i class="fa-solid fa-check"></i>
                                </button>
                                <button onclick="openRejectModal('${order.id}', '${order.userId}', ${order.amount}, '${order.username}')" class="bg-red-600 hover:bg-red-500 text-white p-2 rounded-lg shadow transition active:scale-95" title="H·ªßy ƒë∆°n">
                                    <i class="fa-solid fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                list.innerHTML = html;
            });
        }

        // 4. CH·ª®C NƒÇNG: SOI USER (CHECK USER)
        function checkUser(uid) {
            toggleModal('modal-check-user');
            const content = document.getElementById('user-details-content');
            content.innerHTML = '<div class="text-center py-4"><i class="fa-solid fa-spinner fa-spin text-2xl text-blue-500"></i><p class="mt-2 text-sm text-gray-400">ƒêang l·∫•y d·ªØ li·ªáu...</p></div>';

            db.ref('users/' + uid).once('value', snap => {
                if (!snap.exists()) {
                    content.innerHTML = '<div class="text-center text-red-400"><i class="fa-solid fa-circle-exclamation text-3xl mb-2"></i><br>Kh√¥ng t√¨m th·∫•y User n√†y</div>';
                    return;
                }
                const u = snap.val();
                
                // Logic ph√°t hi·ªán gian l·∫≠n c∆° b·∫£n
                const isSpeedHack = (u.speed > 5.0);
                const isFuelHack = (u.fuel > 100);
                const isRich = (u.coins > 1000000);

                let html = `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div class="bg-gray-900 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-500">S·ªë d∆∞ hi·ªán t·∫°i</p>
                            <p class="text-xl font-bold ${isRich ? 'text-red-400 animate-pulse' : 'text-yellow-400'}">${parseInt(u.coins || 0).toLocaleString()}</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-500">T·ªëc ƒë·ªô ƒë√†o</p>
                            <p class="text-xl font-bold ${isSpeedHack ? 'text-red-500' : 'text-blue-400'}">${u.speed || 1}/5.0 ${isSpeedHack ? '‚ö†Ô∏è' : ''}</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-500">Nhi√™n li·ªáu</p>
                            <p class="text-xl font-bold ${isFuelHack ? 'text-red-500' : 'text-green-400'}">${parseInt(u.fuel || 0)}/100 ${isFuelHack ? '‚ö†Ô∏è' : ''}</p>
                        </div>
                        <div class="bg-gray-900 p-3 rounded border border-gray-700">
                            <p class="text-xs text-gray-500">ƒê√£ m·ªùi</p>
                            <p class="text-xl font-bold text-white">${u.tasks?.inviteCount || 0} ng∆∞·ªùi</p>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 bg-black/20 p-2 rounded font-mono break-all">
                        UID: ${uid}
                    </div>
                `;
                content.innerHTML = html;
            });
        }

        // 5. CH·ª®C NƒÇNG: X√ÅC NH·∫¨N ƒê∆†N (DUY·ªÜT)
        function deleteOrder(id) {
            if(confirm("X√°c nh·∫≠n: ƒê√£ chuy·ªÉn ti·ªÅn cho kh√°ch v√† mu·ªën x√≥a ƒë∆°n n√†y?")) {
                db.ref('withdrawals/' + id).remove()
                    .then(() => {
                        const row = document.getElementById('row-' + id);
                        row.classList.add('opacity-0', 'transform', 'scale-95');
                        setTimeout(() => row.remove(), 200);
                    })
                    .catch(e => alert("L·ªói: " + e.message));
            }
        }

        // 6. CH·ª®C NƒÇNG: T·ª™ CH·ªêI & HO√ÄN TI·ªÄN
        function openRejectModal(id, uid, amount, username) {
            document.getElementById('reject-id').value = id;
            document.getElementById('reject-uid').value = uid;
            document.getElementById('reject-val').value = amount;
            document.getElementById('reject-amount').innerText = parseInt(amount).toLocaleString();
            document.getElementById('reject-user').innerText = username;
            toggleModal('modal-reject');
        }

        function confirmReject() {
            const wid = document.getElementById('reject-id').value;
            const uid = document.getElementById('reject-uid').value;
            const amount = parseInt(document.getElementById('reject-val').value);
            const reason = document.getElementById('reject-reason').value;
            const shouldRefund = document.getElementById('refund-checkbox').checked;

            const updates = {};
            
            // 1. X√≥a ƒë∆°n r√∫t kh·ªèi danh s√°ch ch·ªù
            updates['withdrawals/' + wid] = null;

            // 2. Th√™m v√†o l·ªãch s·ª≠ giao d·ªãch c·ªßa User (Ghi l√Ω do t·ª´ ch·ªëi)
            const historyRef = db.ref('users/' + uid + '/history');
            historyRef.once('value', snap => {
                let history = snap.val() || [];
                // Th√™m log m·ªõi v√†o ƒë·∫ßu danh s√°ch
                history.unshift({
                    amount: amount,
                    status: `‚ùå B·ªã t·ª´ ch·ªëi: ${reason}`,
                    time: new Date().toLocaleString('vi-VN'),
                    bankName: 'Ho√†n ti·ªÅn',
                    bankOwner: 'SYSTEM',
                    bankAcc: shouldRefund ? 'ƒê√£ c·ªông l·∫°i' : 'Kh√¥ng ho√†n'
                });
                if(history.length > 50) history = history.slice(0,50);
                
                db.ref('users/' + uid + '/history').set(history);
            });

            // 3. (N·∫øu ch·ªçn) Ho√†n l·∫°i xu cho kh√°ch
            if (shouldRefund) {
                const userCoinRef = db.ref('users/' + uid + '/coins');
                userCoinRef.transaction(currentCoins => {
                    return (currentCoins || 0) + amount;
                });
            }

            // Th·ª±c thi l·ªánh x√≥a ƒë∆°n
            db.ref().update(updates)
                .then(() => {
                    toggleModal('modal-reject');
                    const row = document.getElementById('row-' + wid);
                    row.classList.add('bg-red-900/50', 'text-red-300'); // Hi·ªáu ·ª©ng ƒë·ªè
                    setTimeout(() => row.remove(), 500);
                    alert(`ƒê√£ h·ªßy ƒë∆°n! ${shouldRefund ? '(ƒê√£ ho√†n ti·ªÅn)' : '(Kh√¥ng ho√†n ti·ªÅn)'}`);
                })
                .catch(e => alert("L·ªói: " + e.message));
        }

        // --- UTILS ---
        function toggleModal(modalID){
            const modal = document.getElementById(modalID);
            modal.classList.toggle('opacity-0');
            modal.classList.toggle('pointer-events-none');
            document.body.classList.toggle('modal-active');
        }
    </script>
</body>
</html>
