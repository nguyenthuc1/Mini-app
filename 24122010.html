<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Duy·ªát R√∫t Ti·ªÅn</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
</head>
<body class="bg-[#0b0f1a] text-white p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-yellow-500 mb-6 flex justify-between items-center">
            QU·∫¢N L√ù R√öT TI·ªÄN
            <button onclick="loadRequests()" class="text-sm bg-blue-600 px-4 py-2 rounded-lg">L√†m m·ªõi üîÑ</button>
        </h1>

        <div class="overflow-x-auto">
            <table class="w-full text-left border-collapse bg-[#161b2c] rounded-xl overflow-hidden shadow-2xl">
                <thead class="bg-[#1e293b] text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="p-4">User ID</th>
                        <th class="p-4">Th√¥ng tin</th>
                        <th class="p-4">S·ªë ti·ªÅn</th>
                        <th class="p-4">Th·ªùi gian</th>
                        <th class="p-4 text-center">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="admin-list" class="text-sm">
                    <tr><td colspan="5" class="p-10 text-center text-gray-500 italic">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // --- COPY CONFIG T·ª™ APP.JS C·ª¶A B·∫†N V√ÄO ƒê√ÇY ---
        const firebaseConfig = {
            apiKey: "AIzaSyAc0psT5Up6aEu0VnCz1TZ4sSNTKmif8oA",
            authDomain: "telegram-bot-backup-11c83.firebaseapp.com",
            databaseURL: "https://telegram-bot-backup-11c83-default-rtdb.firebaseio.com",
            projectId: "telegram-bot-backup-11c83",
            storageBucket: "telegram-bot-backup-11c83.firebasestorage.app",
            messagingSenderId: "363675104532",
            appId: "1:363675104532:web:6c51d1c7318b765e897e01"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        async function loadRequests() {
            const list = document.getElementById('admin-list');
            list.innerHTML = '<tr><td colspan="5" class="p-10 text-center">ƒêang qu√©t l·ªánh r√∫t...</td></tr>';

            try {
                const snap = await db.ref('users').once('value');
                const users = snap.val();
                let html = '';
                let count = 0;

                for (let uid in users) {
                    const userData = users[uid];
                    if (userData.history) {
                        userData.history.forEach((h, index) => {
                            // Ch·ªâ hi·ªán c√°c l·ªánh "ƒêang x·ª≠ l√Ω" [cite: 2026-01-24]
                            if (h.status === 'ƒêang x·ª≠ l√Ω') {
                                count++;
                                html += `
                                <tr class="border-b border-slate-800 hover:bg-slate-800/50">
                                    <td class="p-4 font-mono text-blue-400 text-xs">${uid}</td>
                                    <td class="p-4">
                                        <div class="font-bold text-white">${h.bank}</div>
                                        <div class="text-xs text-gray-400">${h.account} - ${h.name || 'N/A'}</div>
                                    </td>
                                    <td class="p-4 font-bold text-yellow-400">${h.amount.toLocaleString()}ƒë</td>
                                    <td class="p-4 text-gray-500 text-[10px]">${h.time}</td>
                                    <td class="p-4 text-center space-x-2">
                                        <button onclick="updateStatus('${uid}', ${index}, 'Th√†nh c√¥ng')" class="bg-green-600 px-3 py-1 rounded text-[10px] font-bold">DUY·ªÜT</button>
                                        <button onclick="refund('${uid}', ${index}, ${h.amount})" class="bg-red-600 px-3 py-1 rounded text-[10px] font-bold">H·ª¶Y/HO√ÄN</button>
                                    </td>
                                </tr>`;
                            }
                        });
                    }
                }

                list.innerHTML = count > 0 ? html : '<tr><td colspan="5" class="p-10 text-center text-gray-500">üéâ Kh√¥ng c√≥ l·ªánh n√†o ch·ªù duy·ªát!</td></tr>';
            } catch (e) {
                list.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-red-500">L·ªói: ${e.message}</td></tr>`;
            }
        }

        async function updateStatus(uid, index, status) {
            if (!confirm(`X√°c nh·∫≠n l·ªánh r√∫t n√†y ƒë√£ ${status}?`)) return;
            const ref = db.ref(`users/${uid}/history/${index}`);
            await ref.update({ status: status });
            alert("ƒê√£ c·∫≠p nh·∫≠t!");
            loadRequests();
        }

        async function refund(uid, index, amount) {
            if (!confirm("H·ªßy l·ªánh n√†y v√† ho√†n l·∫°i ti·ªÅn cho user?")) return;
            
            // 1. Ho√†n ti·ªÅn [cite: 2026-01-24]
            const userRef = db.ref(`users/${uid}`);
            const snap = await userRef.once('value');
            const data = snap.val();
            const newCoins = (data.coins || 0) + amount;

            // 2. C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† s·ªë d∆∞ [cite: 2026-01-24]
            await userRef.update({ coins: newCoins });
            await userRef.child(`history/${index}`).update({ status: 'B·ªã t·ª´ ch·ªëi (ƒê√£ ho√†n ti·ªÅn)' });
            
            alert("ƒê√£ ho√†n ti·ªÅn!");
            loadRequests();
        }

        window.onload = loadRequests;
    </script>
</body>
</html>
